---
/**
 * Custom Header component that adds navigation tabs similar to the mkdocs Material theme.
 * This replicates the "User Guide", "Examples", "Community" etc. tabs from strandsagents.com
 * 
 * To customize the navigation links, edit src/config/navbar.ts
 */
// @ts-expect-error - Virtual modules are resolved at build time by Starlight
import config from 'virtual:starlight/user-config';

// @ts-expect-error - Virtual modules are resolved at build time by Starlight
import LanguageSelect from 'virtual:starlight/components/LanguageSelect';
// @ts-expect-error - Virtual modules are resolved at build time by Starlight
import Search from 'virtual:starlight/components/Search';
// @ts-expect-error - Virtual modules are resolved at build time by Starlight
import SocialIcons from 'virtual:starlight/components/SocialIcons';
// @ts-expect-error - Virtual modules are resolved at build time by Starlight
import ThemeSelect from 'virtual:starlight/components/ThemeSelect';
import { Icon } from '@astrojs/starlight/components';

import { navLinks, type NavLink } from '../../config/navbar';
import { findCurrentNavSection } from '../../route-middleware';
import logoHeaderDark from '../../assets/logo-header-dark.svg';
import logoHeaderLight from '../../assets/logo-header-light.svg';

// navLinks already include base path, so compare directly with full pathname
const currentPath = Astro.url.pathname;

// Use findCurrentNavSection for consistent longest-match logic
const activeNav = findCurrentNavSection(currentPath, navLinks);

const shouldRenderSearch =
  config.pagefind || config.components?.Search !== '@astrojs/starlight/components/Search.astro';

// Get the site title for accessibility
const { siteTitleHref } = Astro.locals.starlightRoute;
---

<div class="header">
  <div class="header-top">
    <div class="title-wrapper sl-flex">
      <a href={siteTitleHref} class="site-title sl-flex">
        <img src={logoHeaderLight.src} alt="Strands Agents SDK" class="header-logo light-logo" />
        <img src={logoHeaderDark.src} alt="Strands Agents SDK" class="header-logo dark-logo" />
      </a>
    </div>
    <div class="header-spacer"></div>
    {shouldRenderSearch && <div class="search-wrapper print:hidden"><Search /></div>}
    {/* Mobile nav dropdown */}
    {navLinks.length > 0 && (
      <nav class="mobile-nav md:sl-hidden print:hidden" aria-label="Main navigation">
        <details class="mobile-nav-dropdown">
          <summary class="mobile-nav-toggle">
            <span class="mobile-nav-current">
              {activeNav?.label || 'Navigate'}
            </span>
            <Icon name="down-caret" class="mobile-nav-caret" size="1rem" />
          </summary>
          <div class="mobile-nav-menu">
            {navLinks.map((link: NavLink) => {
              const isActive = activeNav?.label === link.label;
              return (
                <a 
                  href={link.href} 
                  class:list={['mobile-nav-link', { active: isActive }]}
                  {...(link.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
                >
                  {link.label}
                  {link.external && <span class="external-icon" aria-hidden="true">↗</span>}
                </a>
              );
            })}
          </div>
        </details>
      </nav>
    )}
    <div class="sl-hidden md:sl-flex print:hidden right-group">
      <div class="sl-flex social-icons">
        <SocialIcons />
      </div>
      <ThemeSelect />
      <LanguageSelect />
    </div>
  </div>
  
  {/* Desktop nav tabs */}
  {navLinks.length > 0 && (
    <nav class="nav-tabs sl-hidden md:sl-flex" aria-label="Main navigation">
      {navLinks.map((link: NavLink) => {
        const isActive = activeNav?.label === link.label;
        return (
          <a 
            href={link.href} 
            class:list={['nav-tab', { active: isActive }]}
            {...(link.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
          >
            {link.label}
            {link.external && <span class="external-icon" aria-hidden="true">↗</span>}
          </a>
        );
      })}
    </nav>
  )}
</div>

<style>
  /*
   * ==========================================================================
   * STRANDS BRAND COLORS
   * ==========================================================================
   * Custom CSS properties for Strands brand colors used throughout the header.
   * Defined globally so they can be referenced in both scoped and global styles.
   */
  :global(:root) {
    --strands-logo-green: #00cc5f;
    --strands-green-bright: #00FF77;
    --strands-green-hover: #00D965;
    --strands-green-active: #00B353;
    --strands-dark-text: #0E0E0E;
    --strands-light-text: white;
  }

  /*
   * ==========================================================================
   * STARLIGHT VARIABLE OVERRIDES
   * ==========================================================================
   * Override Starlight's default nav variables to accommodate our two-row header:
   * - Row 1: Logo, search, social icons, theme/language selectors
   * - Row 2: Navigation tabs (desktop only)
   * 
   * --sl-nav-height: Total height of the header (used by Starlight for page layout)
   * --sl-nav-pad-y: Vertical padding inside the nav container (applied by parent)
   */
  :global(:root) {
    /* Mobile: Single row header */
    --sl-nav-height: 3.5rem;
    --sl-nav-pad-y: 0.5rem;
  }
  @media (min-width: 50rem) {
    :global(:root) {
      /* Desktop: Two-row header (logo row + nav tabs row) */
      --sl-nav-height: 6rem;
      /* Reduced padding to keep header compact with two rows */
      --sl-nav-pad-y: 0.375rem;
    }
  }

  /*
   * ==========================================================================
   * HEADER LAYOUT
   * ==========================================================================
   * Uses @layer starlight.core to ensure styles integrate properly with
   * Starlight's cascade layers and can override default component styles.
   */
  @layer starlight.core {
    /*
     * Main header container - vertical flex layout
     * Contains header-top (row 1) and nav-tabs (row 2 on desktop)
     */
    .header {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /*
     * Top row: Logo | Spacer | Search | Mobile Nav | Right Group
     * 
     * Mobile: Uses flexbox with space-between
     * Desktop: Uses CSS Grid for precise column control (see media query below)
     * 
     * flex: 1 allows this row to expand and fill remaining height after nav-tabs
     */
    .header-top {
      display: flex;
      gap: var(--sl-nav-gap);
      justify-content: space-between;
      align-items: center;
      flex: 1;
    }

    /*
     * Logo wrapper - fixed width prevents layout shift during page load
     * The fixed width (180px) accommodates the logo and prevents the search bar
     * from jumping around as the logo image loads.
     */
    .title-wrapper {
      overflow: clip;
      padding: 0.25rem;
      margin: -0.25rem;
      min-width: 180px;
      width: 180px;
    }

    /*
     * Flexible spacer - pushes right-side elements to the edge
     * In flexbox (mobile): flex: 1 takes available space
     * In grid (desktop): occupies the 1fr column
     */
    .header-spacer {
      flex: 1;
    }

    /* Search wrapper - contains the Starlight Search component */
    .search-wrapper {
      display: flex;
      align-items: center;
    }

    .site-title {
      align-items: center;
      text-decoration: none;
    }

    .header-logo {
      height: 2rem;
      width: auto;
    }

    /*
     * Theme-aware logo switching
     * Shows light logo on light theme, dark logo on dark theme
     * Uses display toggle rather than CSS filters for crisp rendering
     */
    .light-logo {
      display: block;
    }
    .dark-logo {
      display: none;
    }
    :global([data-theme='dark']) .light-logo {
      display: none;
    }
    :global([data-theme='dark']) .dark-logo {
      display: block;
    }

    /*
     * Right group: Social icons, theme selector, language selector
     * Hidden on mobile (md:sl-hidden), shown on desktop (md:sl-flex)
     */
    .right-group {
      gap: 1rem;
      align-items: center;
    }

    .social-icons {
      gap: 1rem;
      align-items: center;
    }
    
    /* Vertical divider before social icons (separates from search) */
    .social-icons::before {
      content: '';
      height: 2rem;
      border-inline-start: 1px solid var(--sl-color-gray-5);
    }

    /*
     * ==========================================================================
     * NAVIGATION TABS (Desktop only)
     * ==========================================================================
     * Second row of the header, visible only on desktop (md:sl-flex)
     * Styled to match the mkdocs Material theme navigation
     */
    .nav-tabs {
      display: flex;
      gap: 0;
      align-items: center;
      border-top: 1px solid var(--sl-color-gray-5);
      flex-shrink: 0;
      /* Fixed height ensures consistent spacing with header-top row */
      height: 2.5rem;
    }

    .nav-tab {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 1rem;
      font-size: 1rem;
      font-weight: 500;
      color: var(--sl-color-text);
      text-decoration: none;
      transition: color 0.2s, text-decoration 0.2s;
      white-space: nowrap;
    }

    /* Hover state with Strands green highlight */
    .nav-tab:hover {
      color: var(--strands-dark-text);
      background-color: rgba(0, 255, 119, 0.1);
      border-radius: 8px;
      text-decoration: none;
    }

    .nav-tab.active {
      color: var(--strands-dark-text);
      text-decoration: none;
    }

    /* Dark theme adjustments for nav tabs */
    :global([data-theme='dark']) .nav-tab:hover {
      color: var(--strands-light-text);
      background-color: rgba(0, 255, 119, 0.05);
    }

    :global([data-theme='dark']) .nav-tab.active {
      color: var(--strands-light-text);
    }

    /* External link indicator arrow */
    .external-icon {
      font-size: 0.75em;
      opacity: 0.7;
      margin-left: 0.125rem;
    }

    /*
     * ==========================================================================
     * MOBILE NAVIGATION DROPDOWN
     * ==========================================================================
     * Replaces nav-tabs on mobile with a compact dropdown menu
     * Uses native <details>/<summary> for accessibility and no-JS fallback
     */
    .mobile-nav {
      position: relative;
    }

    .mobile-nav-dropdown {
      position: relative;
    }

    .mobile-nav-toggle {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--sl-color-text);
      background-color: var(--sl-color-gray-6);
      border-radius: 0.375rem;
      cursor: pointer;
      list-style: none;
      white-space: nowrap;
    }

    /* Hide default details marker across browsers */
    .mobile-nav-toggle::-webkit-details-marker {
      display: none;
    }

    .mobile-nav-toggle::marker {
      display: none;
      content: '';
    }

    /* Animated caret rotation when dropdown is open */
    .mobile-nav-caret {
      transition: transform 0.2s;
      flex-shrink: 0;
    }

    .mobile-nav-dropdown[open] .mobile-nav-caret {
      transform: rotate(180deg);
    }

    /* Dropdown menu panel */
    .mobile-nav-menu {
      position: absolute;
      top: 100%;
      right: 0;
      z-index: var(--sl-z-index-menu);
      display: flex;
      flex-direction: column;
      min-width: 10rem;
      margin-top: 0.25rem;
      padding: 0.5rem;
      background-color: var(--sl-color-bg-nav);
      border: 1px solid var(--sl-color-gray-5);
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .mobile-nav-link {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      color: var(--sl-color-text);
      text-decoration: none;
      border-radius: 0.25rem;
      transition: background-color 0.15s;
    }

    .mobile-nav-link:hover {
      background-color: rgba(0, 255, 119, 0.1);
    }

    :global([data-theme='dark']) .mobile-nav-link:hover {
      background-color: rgba(0, 255, 119, 0.05);
    }

    .mobile-nav-link.active {
      color: var(--sl-color-white);
      font-weight: 600;
    }

    /*
     * ==========================================================================
     * DESKTOP GRID LAYOUT
     * ==========================================================================
     * On desktop, switch header-top from flexbox to CSS Grid for precise control:
     * 
     * Column 1 (180px): Logo - fixed width prevents layout shift
     * Column 2 (1fr): Spacer - flexible, pushes remaining items to the right
     * Column 3 (300px): Search - fixed width for consistent positioning
     * Column 4 (auto): Mobile nav - hidden on desktop but needs grid slot
     * Column 5 (auto): Right group - social icons, theme, language
     */
    @media (min-width: 50rem) {
      .header-top {
        display: grid;
        grid-template-columns: 180px 1fr 300px auto auto;
        align-content: center;
      }
      
      .header-spacer {
        /* In grid context, this element fills the 1fr column */
      }
    }
  }
</style>
