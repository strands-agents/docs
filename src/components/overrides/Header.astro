---
/**
 * Custom Header component that adds navigation tabs similar to the mkdocs Material theme.
 * This replicates the "User Guide", "Examples", "Community" etc. tabs from strandsagents.com
 * 
 * To customize the navigation links, edit src/config/navbar.ts
 */
// @ts-expect-error - Virtual modules are resolved at build time by Starlight
import config from 'virtual:starlight/user-config';

// @ts-expect-error - Virtual modules are resolved at build time by Starlight
import LanguageSelect from 'virtual:starlight/components/LanguageSelect';
// @ts-expect-error - Virtual modules are resolved at build time by Starlight
import Search from 'virtual:starlight/components/Search';
// @ts-expect-error - Virtual modules are resolved at build time by Starlight
import SocialIcons from 'virtual:starlight/components/SocialIcons';
// @ts-expect-error - Virtual modules are resolved at build time by Starlight
import ThemeSelect from 'virtual:starlight/components/ThemeSelect';
import { Icon } from '@astrojs/starlight/components';

import { navLinks, type NavLink } from '../../config/navbar';
import { findCurrentNavSection } from '../../route-middleware';
import logoHeaderDark from '../../assets/logo-header-dark.svg';
import logoHeaderLight from '../../assets/logo-header-light.svg';

// navLinks already include base path, so compare directly with full pathname
const currentPath = Astro.url.pathname;

// Use findCurrentNavSection for consistent longest-match logic
const activeNav = findCurrentNavSection(currentPath, navLinks);

const shouldRenderSearch =
  config.pagefind || config.components?.Search !== '@astrojs/starlight/components/Search.astro';

// Get the site title for accessibility
const { siteTitleHref } = Astro.locals.starlightRoute;
---

<div class="header">
  <div class="header-top">
    <div class="title-wrapper sl-flex">
      <a href={siteTitleHref} class="site-title sl-flex">
        <img src={logoHeaderLight.src} alt="Strands Agents SDK" class="header-logo light-logo" />
        <img src={logoHeaderDark.src} alt="Strands Agents SDK" class="header-logo dark-logo" />
      </a>
    </div>
    <div class="sl-flex print:hidden search-and-nav">
      {shouldRenderSearch && <Search />}
      
      {/* Mobile nav dropdown - next to search */}
      {navLinks.length > 0 && (
        <nav class="mobile-nav md:sl-hidden" aria-label="Main navigation">
          <details class="mobile-nav-dropdown">
            <summary class="mobile-nav-toggle">
              <span class="mobile-nav-current">
                {activeNav?.label || 'Navigate'}
              </span>
              <Icon name="down-caret" class="mobile-nav-caret" size="1rem" />
            </summary>
            <div class="mobile-nav-menu">
              {navLinks.map((link: NavLink) => {
                const isActive = activeNav?.label === link.label;
                return (
                  <a 
                    href={link.href} 
                    class:list={['mobile-nav-link', { active: isActive }]}
                    {...(link.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
                  >
                    {link.label}
                    {link.external && <span class="external-icon" aria-hidden="true">↗</span>}
                  </a>
                );
              })}
            </div>
          </details>
        </nav>
      )}
    </div>
    <div class="sl-hidden md:sl-flex print:hidden right-group">
      <div class="sl-flex social-icons">
        <SocialIcons />
      </div>
      <ThemeSelect />
      <LanguageSelect />
    </div>
  </div>
  
  {/* Desktop nav tabs */}
  {navLinks.length > 0 && (
    <nav class="nav-tabs sl-hidden md:sl-flex" aria-label="Main navigation">
      {navLinks.map((link: NavLink) => {
        const isActive = activeNav?.label === link.label;
        return (
          <a 
            href={link.href} 
            class:list={['nav-tab', { active: isActive }]}
            {...(link.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
          >
            {link.label}
            {link.external && <span class="external-icon" aria-hidden="true">↗</span>}
          </a>
        );
      })}
    </nav>
  )}
</div>

<style>
  /* Override the nav height to account for the additional tabs row on desktop */
  :global(:root) {
    --sl-nav-height: 3.5rem;
  }
  @media (min-width: 50rem) {
    :global(:root) {
      --sl-nav-height: 6.5rem;
    }
  }

  @layer starlight.core {
    .header {
      display: flex;
      flex-direction: column;
      height: 100%;
      justify-content: space-between;
    }

    .header-top {
      display: flex;
      gap: var(--sl-nav-gap);
      justify-content: space-between;
      align-items: center;
      min-height: 0;
    }

    .title-wrapper {
      overflow: clip;
      padding: 0.25rem;
      margin: -0.25rem;
      min-width: 0;
    }

    .site-title {
      align-items: center;
      text-decoration: none;
    }

    .header-logo {
      height: 2rem;
      width: auto;
    }

    /* Show light logo in light theme, dark logo in dark theme */
    .light-logo {
      display: block;
    }
    .dark-logo {
      display: none;
    }
    :global([data-theme='dark']) .light-logo {
      display: none;
    }
    :global([data-theme='dark']) .dark-logo {
      display: block;
    }

    .right-group,
    .social-icons {
      gap: 1rem;
      align-items: center;
    }
    
    .social-icons::after {
      content: '';
      height: 2rem;
      border-inline-end: 1px solid var(--sl-color-gray-5);
    }

    /* Navigation tabs styling - matching mkdocs Material theme */
    .nav-tabs {
      display: flex;
      gap: 0;
      align-items: center;
      border-top: 1px solid var(--sl-color-gray-5);
      padding-top: 0.25rem;
      flex-shrink: 0;
    }

    .nav-tab {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 1rem;
      font-size: 1rem;
      font-weight: 500;
      color: var(--sl-color-text);
      text-decoration: none;
      transition: color 0.2s, text-decoration 0.2s;
      white-space: nowrap;
    }

    .nav-tab:hover {
      color: var(--sl-color-text-accent);
      text-decoration: underline;
      text-underline-offset: 0.5em;
    }

    .nav-tab.active {
      color: var(--sl-color-text-accent);
      text-decoration: underline;
      text-underline-offset: 0.5em;
    }

    .external-icon {
      font-size: 0.75em;
      opacity: 0.7;
      margin-left: 0.125rem;
    }

    /* Mobile navigation dropdown */
    .search-and-nav {
      gap: 0.5rem;
      align-items: center;
    }

    .mobile-nav {
      position: relative;
    }

    .mobile-nav-dropdown {
      position: relative;
    }

    .mobile-nav-toggle {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--sl-color-text);
      background-color: var(--sl-color-gray-6);
      border-radius: 0.375rem;
      cursor: pointer;
      list-style: none;
      white-space: nowrap;
    }

    .mobile-nav-toggle::-webkit-details-marker {
      display: none;
    }

    .mobile-nav-toggle::marker {
      display: none;
      content: '';
    }

    .mobile-nav-caret {
      transition: transform 0.2s;
      flex-shrink: 0;
    }

    .mobile-nav-dropdown[open] .mobile-nav-caret {
      transform: rotate(180deg);
    }

    .mobile-nav-menu {
      position: absolute;
      top: 100%;
      right: 0;
      z-index: var(--sl-z-index-menu);
      display: flex;
      flex-direction: column;
      min-width: 10rem;
      margin-top: 0.25rem;
      padding: 0.5rem;
      background-color: var(--sl-color-bg-nav);
      border: 1px solid var(--sl-color-gray-5);
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .mobile-nav-link {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      color: var(--sl-color-text);
      text-decoration: none;
      border-radius: 0.25rem;
      transition: background-color 0.15s;
    }

    .mobile-nav-link:hover {
      background-color: var(--sl-color-gray-6);
    }

    .mobile-nav-link.active {
      color: var(--sl-color-text-accent);
      font-weight: 600;
    }

    @media (min-width: 50rem) {
      :global(:root[data-has-sidebar]) {
        --__sidebar-pad: calc(2 * var(--sl-nav-pad-x));
      }
      :global(:root:not([data-has-toc])) {
        --__toc-width: 0rem;
      }
      .header-top {
        --__sidebar-width: max(0rem, var(--sl-content-inline-start, 0rem) - var(--sl-nav-pad-x));
        --__main-column-fr: calc(
          (
              100% + var(--__sidebar-pad, 0rem) - var(--__toc-width, var(--sl-sidebar-width)) -
                (2 * var(--__toc-width, var(--sl-nav-pad-x))) - var(--sl-content-inline-start, 0rem) -
                var(--sl-content-width)
            ) / 2
        );
        display: grid;
        grid-template-columns:
          minmax(
            calc(var(--__sidebar-width) + max(0rem, var(--__main-column-fr) - var(--sl-nav-gap))),
            auto
          )
          1fr
          auto;
        align-content: center;
      }
    }
  }
</style>
