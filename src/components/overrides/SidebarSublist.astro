---
interface Props {
  sublist: any[];
  nested?: boolean;
  depth?: number;
}

const { sublist = [], nested = false, depth = 0 } = Astro.props;
const isTopLevel = depth === 0;

function hasCurrentChild(entries: any[]): boolean {
  return entries.some((e: any) => 
    e.type === "link" ? e.isCurrent : hasCurrentChild(e.entries || [])
  );
}

function getFirstLink(entries: any[]): string | null {
  for (const entry of entries) {
    if (entry.type === "link") return entry.href;
    if (entry.entries) {
      const found = getFirstLink(entry.entries);
      if (found) return found;
    }
  }
  return null;
}

const caret = `<path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/>`;
---

<ul class:list={{ "top-level": !nested }}>
  {sublist.map((entry: any) => {
    const firstLink = entry.type !== "link" ? getFirstLink(entry.entries || []) : null;
    
    return (
      <li>
        {entry.type === "link" ? (
          <a href={entry.href} aria-current={entry.isCurrent ? "page" : undefined} class:list={[{ large: !nested }, entry.attrs?.class]}>
            <span>{entry.label}</span>
          </a>
        ) : isTopLevel ? (
          /* Top-level groups: non-collapsible section headers */
          <div class="section-group">
            <span class="section-label">{entry.label}</span>
            <Astro.self sublist={entry.entries} nested={true} depth={depth + 1} />
          </div>
        ) : (
          /* Nested groups: link + collapsible caret */
          <details open={hasCurrentChild(entry.entries) || !entry.collapsed}>
            <summary>
              {firstLink ? (
                <a href={firstLink} class="group-link">{entry.label}</a>
              ) : (
                <span class="group-label">{entry.label}</span>
              )}
              <svg aria-hidden="true" class="caret" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" set:html={caret} />
            </summary>
            <Astro.self sublist={entry.entries} nested={true} depth={depth + 1} />
          </details>
        )}
      </li>
    );
  })}
</ul>

<style>
  @layer starlight.core {
    ul { --sl-sidebar-item-padding-inline: 0.5rem; list-style: none; padding: 0; }
    li { overflow-wrap: anywhere; }
    /* Only indent items at depth 2+ (skip first level under section headers) */
    ul ul ul li { margin-inline-start: var(--sl-sidebar-item-padding-inline); border-inline-start: 1px solid var(--sl-color-hairline-light); padding-inline-start: var(--sl-sidebar-item-padding-inline); }
    .large { font-size: var(--sl-text-lg); font-weight: 600; color: var(--sl-color-white); }
    .top-level > li + li { margin-top: 0.75rem; }
    
    /* Top-level section headers */
    .section-group { margin-bottom: 0.25rem; }
    .section-label { display: block; font-weight: 700; color: var(--sl-color-white); text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.6875rem; padding: 0.5em var(--sl-sidebar-item-padding-inline); }
    
    /* Collapsible group summary - styled like links */
    summary { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 0.3em var(--sl-sidebar-item-padding-inline); 
      line-height: 1.4; 
      cursor: pointer; 
      user-select: none;
      border-radius: 0.25rem;
      color: var(--sl-color-gray-2);
    }
    summary:hover, summary:focus { color: var(--sl-color-white); }
    summary::marker, summary::-webkit-details-marker { display: none; }
    
    /* Group link - navigates to first item */
    .group-link {
      flex: 1;
      font-size: var(--sl-text-sm);
      text-decoration: none;
      color: var(--sl-color-gray-2);
    }
    .group-link:hover { color: var(--sl-color-white); }
    
    /* Group label fallback - same styling as link text */
    .group-label { 
      flex: 1;
      font-size: var(--sl-text-sm);
    }
    
    /* Caret icon */
    .caret { 
      transition: transform 0.2s ease-in-out; 
      flex-shrink: 0; 
      width: 1.25rem; 
      height: 1.25rem;
      color: var(--sl-color-gray-3);
    }
    :global([dir="rtl"]) .caret { transform: rotateZ(180deg); }
    [open] > summary .caret { transform: rotateZ(90deg); }
    
    /* Links */
    a:not(.group-link) { 
      display: block; 
      border-radius: 0.25rem; 
      text-decoration: none; 
      color: var(--sl-color-gray-2); 
      padding: 0.3em var(--sl-sidebar-item-padding-inline); 
      line-height: 1.4; 
    }
    a:not(.group-link):hover, a:not(.group-link):focus { color: var(--sl-color-white); }
    a[aria-current="page"], a[aria-current="page"]:hover, a[aria-current="page"]:focus { 
      font-weight: 600; 
      color: var(--sl-color-text-invert); 
      background-color: var(--sl-color-text-accent); 
    }
    .group-link[aria-current="page"], .group-link[aria-current="page"]:hover, .group-link[aria-current="page"]:focus {
      color: var(--sl-color-text-invert);
    }
    
    a > *:not(:last-child), .group-label > *:not(:last-child) { margin-inline-end: 0.25em; }
    
    @media (min-width: 50rem) { 
      .top-level > li + li { margin-top: 0.5rem; } 
      .large { font-size: var(--sl-text-base); } 
      a:not(.group-link) { font-size: var(--sl-text-sm); }
    }
  }
</style>
